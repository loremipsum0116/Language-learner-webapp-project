// src/pages/Dashboard.jsx
import React, { useEffect, useMemo, useState, useRef } from 'react';
import { createPortal } from 'react-dom';
import { Link } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { fetchJSON, withCreds, isAbortError } from '../api/client';
import { SrsApi } from '../api/srs';
import RainbowStar from '../components/RainbowStar';
import LanguageSelectionModal from '../components/LanguageSelectionModal';

// dayjs(KST ÎùºÎ≤®Ïö©)
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import tz from 'dayjs/plugin/timezone';
dayjs.extend(utc); dayjs.extend(tz);
dayjs.tz.setDefault("Asia/Seoul");
const todayKst = () => dayjs().tz('Asia/Seoul').format('YYYY-MM-DD');

function StatCard({ title, value, icon, link, linkText, loading, showDetails, onDetailsClick, detailsButtonRef }) {
    return (
        <div className="card h-100">
            <div className="card-body text-center">
                <div className="d-flex justify-content-center align-items-center mb-2">
                    {icon}
                    <h5 className="card-title ms-2 mb-0">{title}</h5>
                </div>
                {loading ? (
                    <div className="spinner-border spinner-border-sm" role="status">
                        <span className="visually-hidden">Loading...</span>
                    </div>
                ) : (
                    <p className="display-4 fw-bold mb-1">{value}</p>
                )}
                <div className="d-flex justify-content-center gap-2 align-items-center">
                    {link && <Link to={link}>{linkText}</Link>}
                    {showDetails && (
                        <button 
                            ref={detailsButtonRef}
                            className="btn btn-sm btn-outline-secondary"
                            onClick={onDetailsClick}
                            style={{ fontSize: '0.75rem', padding: '0.25rem 0.5rem' }}
                        >
                            ÏÉÅÏÑ∏Î≥¥Í∏∞ ‚ñº
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
}

export default function Dashboard() {
    const { user } = useAuth();
    const [stats, setStats] = useState({ srsQueue: 0, odatNote: 0, masteredWords: 0 });
    const [masteredCards, setMasteredCards] = useState([]);
    const [loading, setLoading] = useState(true);
    const [srsStatus, setSrsStatus] = useState(null);
    const [streakInfo, setStreakInfo] = useState(null);
    const [todayStudyLog, setTodayStudyLog] = useState(null);
    const [showStudyDetails, setShowStudyDetails] = useState(false);
    const [showMasteredDetails, setShowMasteredDetails] = useState(false);
    const [showLanguageModal, setShowLanguageModal] = useState(false);
    const dropdownButtonRef = useRef(null);
    const masteredButtonRef = useRef(null);

    // üîî Ïò§Îäò(KST) Î£®Ìä∏ Ìè¥ÎçîÏùò ÎØ∏ÌïôÏäµ Ìï©Í≥Ñ + Í∞ÄÏû• Ïù¥Î•∏ ÏïåÎ¶ºÏãúÍ∞Å
    const [alarm, setAlarm] = useState({ totalDue: 0, nextAlarmAtKst: null });

    useEffect(() => {
        const ac = new AbortController();

        (async () => {
            try {
                setLoading(true);

                // 1) Ïπ¥Îìú/Ïò§Îãµ/ÎßàÏä§ÌÑ∞ ÌÜµÍ≥Ñ Î≥ëÎ†¨ Î°úÎî©
                const [srsQueueRes, odatNoteRes, masteredCardsRes] = await Promise.all([
                    fetchJSON('/srs/available', withCreds({ signal: ac.signal })),
                    fetchJSON('/api/odat-note/categories', withCreds({ signal: ac.signal })), // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌÜµÍ≥Ñ ÏÇ¨Ïö©
                    fetchJSON('/srs/mastered-cards', withCreds({ signal: ac.signal })),
                ]);

                if (!ac.signal.aborted) {
                    // VocabListÏôÄ ÎèôÏùºÌïú Î∞©ÏãùÏúºÎ°ú ÎßàÏä§ÌÑ∞Îêú Ïπ¥Îìú Ïπ¥Ïö¥Ìä∏
                    const masteredData = Array.isArray(masteredCardsRes.data) ? masteredCardsRes.data : [];
                    const masteredCount = masteredData.length;
                    
                    console.log('[Dashboard] Mastered cards API response:', masteredData);
                    console.log('[Dashboard] Mastered count from /srs/mastered-cards:', masteredCount);
                    console.log('[Dashboard] Sample mastered card structure:', masteredData[0]);
                    
                    // ÏÉàÎ°úÏö¥ Ïñ∏Ïñ¥Î≥Ñ Î∂ÑÎ•ò ÏùëÎãµ Ï≤òÎ¶¨
                    const srsData = srsQueueRes.data;
                    const totalSrsCards = srsData?.total || 0;
                    const japaneseCards = srsData?.japanese || [];
                    const englishCards = srsData?.english || [];
                    const hasMultipleLanguages = srsData?.hasMultipleLanguages || false;

                    console.log('[Dashboard] SRS Cards - Japanese:', japaneseCards.length, 'English:', englishCards.length, 'Multiple Languages:', hasMultipleLanguages);

                    setStats({
                        srsQueue: totalSrsCards,
                        odatNote: odatNoteRes.data?.vocab?.total || 0, // Ïñ¥Ìúò Ïò§Îãµ ÎÖ∏Ìä∏ Í∞úÏàòÎßå ÌëúÏãú
                        masteredWords: masteredCount,
                        // Ïñ∏Ïñ¥Î≥Ñ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                        srsJapanese: japaneseCards.length,
                        srsEnglish: englishCards.length,
                        hasMultipleLanguages: hasMultipleLanguages,
                        japaneseCards: japaneseCards,
                        englishCards: englishCards
                    });
                    
                    // ÎßàÏä§ÌÑ∞Îêú Ïπ¥Îìú Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    setMasteredCards(masteredData);
                    console.log('[Dashboard] Sample mastered card with vocab:', masteredData[0]);
                }

                // 2) Ïò§Îäò Î£®Ìä∏(id) Ï∞æÍ≥† ‚Üí ÌïòÏúÑ Ìè¥Îçî children-liteÎ°ú dueCount/nextAlarmAt ÏàòÏßë
                //    SrsApi.pickerÎäî ÏÑúÎ≤ÑÏóêÏÑú Î£®Ìä∏ Î™©Î°ùÏùÑ Ï£ºÎäî Ï†ÑÏ†ú(Ïù¥ÎØ∏ ÌîÑÎ°úÏ†ùÌä∏Ïóê Ï°¥Ïû¨)
                let rootId = null;
                try {
                    const picker = await SrsApi.picker(); // GET /srs/folders/picker
                    const roots = Array.isArray(picker) ? picker : (picker?.data ?? []);
                    const root = roots.find(r => r?.name === todayKst());
                    rootId = root?.id ?? null;
                } catch {
                    // picker ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎúÄ
                }

                if (rootId && !ac.signal.aborted) {
                    const list = await SrsApi.listChildrenLite(rootId); // GET /srs/folders/:rootId/children-lite
                    const children = Array.isArray(list) ? list : (list?.data ?? []);
                    const totalDue = children.reduce((s, f) => s + (f?.dueCount ?? 0), 0);

                    // Í∞ÄÏû• Ïù¥Î•∏ nextAlarmAt (ÏûàÏúºÎ©¥ KST Ìè¨Îß∑)
                    const nexts = children.map(c => c?.nextAlarmAt).filter(Boolean);
                    const earliest = nexts.length
                        ? dayjs(Math.min(...nexts.map(d => new Date(d).getTime()))).tz('Asia/Seoul').format('YYYY-MM-DD HH:mm')
                        : null;

                    setAlarm({ totalDue, nextAlarmAtKst: earliest, rootId, children });
                } else {
                    setAlarm({ totalDue: 0, nextAlarmAtKst: null });
                }
                
                // 3) SRS ÏÉÅÌÉú Ï†ïÎ≥¥ Î°úÎìú (ÏÉàÎ°úÏö¥ overdue ÏïåÎ¶ºÏö©)
                try {
                    const statusRes = await fetchJSON('/srs/status', withCreds({ signal: ac.signal }));
                    if (!ac.signal.aborted) {
                        setSrsStatus(statusRes.data);
                    }
                } catch (e) {
                    if (!isAbortError(e)) console.warn('SRS ÏÉÅÌÉú Î°úÎî© Ïã§Ìå®:', e);
                }
                
                // 4) Ïó∞ÏÜçÌïôÏäµÏùº Ï†ïÎ≥¥ Î°úÎìú
                try {
                    const streakRes = await fetchJSON('/srs/streak', withCreds({ signal: ac.signal }));
                    if (!ac.signal.aborted) {
                        setStreakInfo(streakRes.data);
                    }
                } catch (e) {
                    if (!isAbortError(e)) console.warn('Ïó∞ÏÜçÌïôÏäµÏùº Î°úÎî© Ïã§Ìå®:', e);
                }
                
                // 5) Ïò§Îäò ÌïôÏäµ Î°úÍ∑∏ Î°úÎìú (SRS ÎåÄÏãúÎ≥¥ÎìúÏôÄ ÎèôÏùºÌïú Î∞©Ïãù)
                const today = dayjs().tz('Asia/Seoul').format('YYYY-MM-DD');
                try {
                    const studyLogRes = await fetchJSON(`/srs/study-log?date=${today}`, withCreds({ signal: ac.signal }));
                    if (!ac.signal.aborted) {
                        setTodayStudyLog(studyLogRes.data || studyLogRes);
                    }
                } catch (err) {
                    if (!isAbortError(err)) {
                        console.warn('Study log API failed:', err);
                        // API Ïã§Ìå®Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                        setTodayStudyLog({
                            studies: [],
                            stats: {
                                totalStudied: 0,
                                uniqueWords: 0,
                                errorRate: 0,
                                successRate: 0
                            }
                        });
                    }
                }
                
            } catch (e) {
                if (!isAbortError(e)) console.error('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', e);
            } finally {
                if (!ac.signal.aborted) setLoading(false);
            }
        })();

        return () => ac.abort();
    }, []);


    const cefrLevel = user?.profile?.level || 'A1';

    // SRS Î≥µÏäµ ÏãúÏûë Î≤ÑÌäº ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
    const handleSrsStartClick = () => {
        console.log('[Dashboard] SRS Î≥µÏäµ ÏãúÏûë ÌÅ¥Î¶≠');
        console.log('Japanese cards:', stats.srsJapanese);
        console.log('English cards:', stats.srsEnglish);
        console.log('Has multiple languages:', stats.hasMultipleLanguages);

        // Ïñ∏Ïñ¥Í∞Ä ÌïòÎÇòÎßå ÏûàÎäî Í≤ΩÏö∞ Î∞îÎ°ú Ìï¥Îãπ Ïñ∏Ïñ¥ ÌÄ¥Ï¶à ÌÉÄÏûÖ ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú Ïù¥Îèô
        if (!stats.hasMultipleLanguages) {
            if (stats.srsJapanese > 0 && stats.srsEnglish === 0) {
                // ÏùºÎ≥∏Ïñ¥Îßå ÏûàÎäî Í≤ΩÏö∞ - LearnVocabÏúºÎ°ú Ïù¥Îèô
                console.log('[Dashboard] ÏùºÎ≥∏Ïñ¥Îßå ÏûàÏùå - ÏùºÎ≥∏Ïñ¥ ÌÄ¥Ï¶à ÌÉÄÏûÖ ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú Ïù¥Îèô');
                window.location.href = '/learn/vocab?mode=all_overdue';
            } else if (stats.srsEnglish > 0 && stats.srsJapanese === 0) {
                // ÏòÅÏñ¥Îßå ÏûàÎäî Í≤ΩÏö∞ - LearnVocabÏúºÎ°ú Ïù¥Îèô
                console.log('[Dashboard] ÏòÅÏñ¥Îßå ÏûàÏùå - ÏòÅÏñ¥ ÌÄ¥Ï¶à ÌÉÄÏûÖ ÏÑ†ÌÉùÏ∞ΩÏúºÎ°ú Ïù¥Îèô');
                window.location.href = '/learn/vocab?mode=all_overdue';
            } else {
                // Ïπ¥ÎìúÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
                console.log('[Dashboard] Î≥µÏäµÌï† Ïπ¥ÎìúÍ∞Ä ÏóÜÏùå');
                alert('Î≥µÏäµÌï† Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.');
            }
        } else {
            // Ïó¨Îü¨ Ïñ∏Ïñ¥Í∞Ä ÏÑûÏó¨ÏûàÎäî Í≤ΩÏö∞ Ïñ∏Ïñ¥ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
            console.log('[Dashboard] Ïó¨Îü¨ Ïñ∏Ïñ¥ ÏÑûÏûÑ - Ïñ∏Ïñ¥ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú');
            setShowLanguageModal(true);
        }
    };

    // Ïñ∏Ïñ¥ ÏÑ†ÌÉù Ìï∏Îì§Îü¨
    const handleLanguageSelect = (language) => {
        console.log('[Dashboard] Ïñ∏Ïñ¥ ÏÑ†ÌÉù:', language);
        if (language === 'japanese') {
            window.location.href = '/learn/vocab?mode=all_overdue';
        } else if (language === 'english') {
            window.location.href = '/learn/vocab?mode=all_overdue';
        }
    };

    // Ïò§Îäò ÌïôÏäµÌïú Îã®Ïñ¥Îì§ÏùÑ Í∑∏Î£πÌôîÌïòÍ≥† ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ (SRS ÎåÄÏãúÎ≥¥ÎìúÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
    const processTodayStudyData = () => {
        // streakInfoÏóêÏÑú Ïã§Ï†ú ÌïôÏäµ ÌöüÏàòÎ•º Ïö∞ÏÑ† ÏÇ¨Ïö©
        const actualStudyCount = streakInfo?.dailyQuizCount || 0;
        
        if (!todayStudyLog || !todayStudyLog.studies) {
            // API Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ streakInfoÎ•º Í∏∞Î∞òÏúºÎ°ú Ï∂îÏ†ï
            return { 
                wordCounts: {}, 
                wordFirstAttempts: {},
                totalAttempts: actualStudyCount, 
                wrongAttempts: 0, 
                errorRate: 0,
                isEstimated: actualStudyCount > 0 // Ï∂îÏ†ï Îç∞Ïù¥ÌÑ∞ÏûÑÏùÑ ÌëúÏãú
            };
        }

        const wordFirstAttempts = {}; // lemmaÎ≥Ñ Ï≤´ ÏãúÎèÑ Ï∂îÏ†Å
        
        // ÌïôÏäµ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Ï≤´ ÏãúÎèÑÎßå Ï≤òÎ¶¨
        todayStudyLog.studies.forEach(card => {
            const lemma = card.vocab?.lemma || card.lemma || 'ÎØ∏ÏÉÅ';
            
            // lemmaÎ≥Ñ Ï≤´ ÌïôÏäµÎßå Í∏∞Î°ù
            if (!wordFirstAttempts[lemma]) {
                // Ï†ïÎãµ/Ïò§Îãµ Ïó¨Î∂Ä ÌåêÎã®
                let isCorrect = false;
                if (card.todayFirstResult !== null && card.todayFirstResult !== undefined) {
                    isCorrect = card.todayFirstResult === true;
                } else if (card.isTodayStudy && card.stage !== undefined) {
                    // Ïò§Îäò Ï≤òÏùå ÌïôÏäµÌïú Ïπ¥ÎìúÎäî stage > 0Ïù¥Î©¥ Ï†ïÎãµ
                    isCorrect = card.stage > 0;
                }
                
                wordFirstAttempts[lemma] = {
                    word: lemma,
                    isCorrect,
                    folderId: card.folderId,
                    time: card.studiedAt || new Date().toISOString()
                };
            }
        });

        // ÏÑúÎ≤Ñ Ï†úÍ≥µ ÌÜµÍ≥ÑÎ•º ÏÇ¨Ïö© (Í∞ÄÏû• Ï†ïÌôïÌï®)
        const totalAttempts = todayStudyLog.stats?.todayTotalAttempts || actualStudyCount;
        const errorRate = todayStudyLog.stats?.errorRate || 0;

        return { 
            wordFirstAttempts,
            totalAttempts, 
            errorRate,
            isEstimated: false
        };
    };

    const { wordFirstAttempts, totalAttempts, errorRate, isEstimated } = processTodayStudyData();

    // üîî Í∏∞Ï°¥ ÏïåÎ¶º Î¨∏Íµ¨ (Ìè¥Îçî ÏãúÏä§ÌÖúÏö©)
    const alarmText = useMemo(() => {
        if (!alarm.totalDue) return null;
        const when = alarm.nextAlarmAtKst ? ` (Îã§Ïùå ÏïåÎ¶º: ${alarm.nextAlarmAtKst})` : '';
        return `Ïò§Îäò ÎØ∏ÌïôÏäµ ${alarm.totalDue}Í∞úÍ∞Ä ÎÇ®ÏïòÏäµÎãàÎã§.${when}`;
    }, [alarm]);
    
    // üîî ÏÉàÎ°úÏö¥ Overdue ÏïåÎ¶º Ïª¥Ìè¨ÎÑåÌä∏
    const OverdueAlertBanner = () => {
        if (!srsStatus?.shouldShowAlarm || !srsStatus?.alarmInfo) return null;
        
        const { overdueCount, alarmInfo } = srsStatus;
        const { currentPeriod, nextAlarmAtKst, minutesToNextAlarm, periodProgress } = alarmInfo;
        
        return (
            <div className="alert alert-danger mb-4" role="alert">
                <div className="d-flex align-items-center justify-content-between">
                    <div className="flex-grow-1">
                        <div className="d-flex align-items-center mb-2">
                            <strong className="me-2">‚ö†Ô∏è Í∏¥Í∏â Î≥µÏäµ ÏïåÎ¶º</strong>
                            <span className="badge bg-dark text-white me-2">{overdueCount}Í∞ú</span>
                            <span className="text-muted small">
                                ÏïåÎ¶º Ï£ºÍ∏∞: {currentPeriod}
                            </span>
                        </div>
                        <div className="mb-2">
                            Î≥µÏäµ Í∏∞ÌïúÏù¥ ÏûÑÎ∞ïÌïú Îã®Ïñ¥Í∞Ä <strong className="text-danger">{overdueCount}Í∞ú</strong> ÏûàÏäµÎãàÎã§.
                            <br />
                            <small className="text-muted">
                                Îã§Ïùå ÏïåÎ¶º: <strong>{nextAlarmAtKst}</strong> ({minutesToNextAlarm}Î∂Ñ ÌõÑ)
                            </small>
                        </div>
                        {/* ÏßÑÌñâ Î∞î */}
                        <div className="progress" style={{ height: '6px' }}>
                            <div 
                                className="progress-bar bg-danger" 
                                style={{ width: `${periodProgress}%` }}
                                title={`ÌòÑÏû¨ ÏïåÎ¶º Ï£ºÍ∏∞ ${periodProgress}% Í≤ΩÍ≥º`}
                            ></div>
                        </div>
                    </div>
                    <div className="ms-3">
                        <Link to="/learn/vocab?mode=all_overdue" className="btn btn-danger">
                            <strong>ÏßÄÍ∏à Î≥µÏäµÌïòÍ∏∞</strong>
                        </Link>
                    </div>
                </div>
            </div>
        );
    };

    return (
        <main className="container py-4" style={{ overflow: 'visible' }}>
            {/* ÌôòÏòÅ ÏÑπÏÖò */}
            <section className="mb-4 p-4 rounded" style={{ backgroundColor: 'var(--bs-light)' }}>
                <h2 className="mb-1">Welcome, {user?.email}!</h2>
                <p className="text-muted">
                    ÌòÑÏû¨ ÏÑ§Ï†ïÎêú ÌïôÏäµ Î†àÎ≤®ÏùÄ <strong>{cefrLevel}</strong> ÏûÖÎãàÎã§. Ïò§ÎäòÎèÑ Íæ∏Ï§ÄÌûà ÌïôÏäµÌï¥ Î≥¥ÏÑ∏Ïöî!
                </p>
            </section>

            {/* üîî Í∏¥Í∏â Overdue ÏïåÎ¶º Î∞∞ÎÑà (Ïö∞ÏÑ†ÏàúÏúÑ 1) */}
            <OverdueAlertBanner />

            {/* üîî ÏùºÎ∞ò Ìè¥Îçî ÏïåÎ¶º Î∞∞ÎÑà (Ïö∞ÏÑ†ÏàúÏúÑ 2) */}
            {alarmText && !srsStatus?.shouldShowAlarm && (
                <div className="alert alert-warning d-flex align-items-center justify-content-between" role="alert">
                    <div>üîî {alarmText}</div>
                    <div className="ms-3">
                        <Link to="/learn/vocab" className="btn btn-sm btn-warning">SRSÎ°ú Ïù¥Îèô</Link>
                    </div>
                </div>
            )}

            {/* ÌïµÏã¨ ÏßÄÌëú */}
            <section className="row g-3 mb-4" style={{ overflow: 'visible' }}>
                <div className="col-md-6 col-lg-3">
                    <div className="card h-100">
                        <div className="card-body text-center d-flex flex-column">
                            <div className="text-primary mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" className="bi bi-stack" viewBox="0 0 16 16">
                                    <path d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.598.598 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535L7.733.063z" />
                                </svg>
                            </div>
                            <h6 className="card-title text-muted">ü¶ú Ïò§ÎäòÏùò SRS</h6>
                            <div className="mb-2">
                                {loading ? (
                                    <div className="placeholder-glow">
                                        <span className="placeholder col-6"></span>
                                    </div>
                                ) : (
                                    <>
                                        <div className="h4 mb-1">Î≥µÏäµ ÎåÄÍ∏∞: <span className="text-primary">{stats.srsQueue}</span> Í∞ú</div>
                                        {stats.hasMultipleLanguages && (
                                            <small className="text-muted">
                                                üáØüáµ {stats.srsJapanese}Í∞ú ‚Ä¢ üá∫üá∏ {stats.srsEnglish}Í∞ú
                                            </small>
                                        )}
                                    </>
                                )}
                            </div>
                            <div className="mt-auto">
                                {stats.srsQueue > 0 && (
                                    <button
                                        className="btn btn-warning btn-sm"
                                        onClick={handleSrsStartClick}
                                        disabled={loading}
                                    >
                                        Î≥µÏäµ ÏãúÏûë
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
                <div className="col-md-6 col-lg-3">
                    <StatCard
                        title="Ïò§Îãµ ÎÖ∏Ìä∏ Îã®Ïñ¥"
                        value={stats.odatNote}
                        loading={loading}
                        icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" className="bi bi-journal-x" viewBox="0 0 16 16"><path fillRule="evenodd" d="M6.146 6.146a.5.5 0 0 1 .708 0L8 7.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 8l1.147 1.146a.5.5 0 0 1-.708.708L8 8.707l-1.146 1.147a.5.5 0 0 1-.708-.708L7.293 8 6.146 6.854a.5.5 0 0 1 0-.708z" /><path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z" /><path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z" /></svg>}
                    />
                </div>
                <div className="col-md-6 col-lg-3">
                    <StatCard
                        title="ÎßàÏä§ÌÑ∞ Ìïú Îã®Ïñ¥"
                        value={stats.masteredWords}
                        loading={loading}
                        icon={<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" className="bi bi-award" viewBox="0 0 16 16"><path d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68L9.669.864zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702 1.509.229z"/><path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1 4 11.794z"/></svg>}
                        showDetails={stats.masteredWords > 0}
                        onDetailsClick={() => setShowMasteredDetails(!showMasteredDetails)}
                        detailsButtonRef={masteredButtonRef}
                    />
                </div>
                <div className="col-md-6 col-lg-3" style={{ overflow: 'visible' }}>
                    {/* Ïó∞ÏÜçÌïôÏäµ Ïπ¥Îìú (SRS ÎåÄÏãúÎ≥¥ÎìúÏôÄ ÎèôÏùºÌïú Ïä§ÌÉÄÏùº) */}
                    <div className="card h-100" style={{ overflow: 'visible' }}>
                        <div className="card-body">
                            {loading ? (
                                <div className="text-center">
                                    <div className="spinner-border spinner-border-sm" role="status">
                                        <span className="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            ) : streakInfo ? (
                                <>
                                    <div className="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 className="card-title">
                                                {streakInfo?.status?.icon || 'üî•'} Ïó∞ÏÜç ÌïôÏäµ
                                            </h5>
                                            <h2 className="mb-1" style={{ 
                                                color: streakInfo?.status?.color === 'gray' ? '#6c757d' :
                                                       streakInfo?.status?.color === 'blue' ? '#0d6efd' :
                                                       streakInfo?.status?.color === 'green' ? '#198754' :
                                                       streakInfo?.status?.color === 'orange' ? '#fd7e14' :
                                                       streakInfo?.status?.color === 'purple' ? '#6f42c1' : '#0d6efd'
                                            }}>
                                                {streakInfo.streak}Ïùº
                                            </h2>
                                            <small className={`text-${
                                                streakInfo?.status?.color === 'purple' ? 'primary' : 'muted'
                                            }`}>
                                                {streakInfo?.status?.message || ''}
                                            </small>
                                        </div>
                                        {/* Î≥¥ÎÑàÏä§ Î±ÉÏßÄ */}
                                        {streakInfo?.bonus?.current && (
                                            <span className="badge bg-warning text-dark fs-6">
                                                {streakInfo.bonus.current.emoji} {streakInfo.bonus.current.title}
                                            </span>
                                        )}
                                    </div>
                                    
                                    {/* ÏßÑÌñâÎ•† Î∞î */}
                                    <div className="progress mb-2" style={{height: '20px'}}>
                                        <div 
                                            className={`progress-bar ${
                                                totalAttempts >= streakInfo.requiredDaily ? 'bg-success' : 'bg-primary'
                                            }`}
                                            style={{width: `${Math.min(100, (totalAttempts / streakInfo.requiredDaily) * 100)}%`}}
                                        >
                                            {totalAttempts}/{streakInfo.requiredDaily}
                                        </div>
                                    </div>
                                    
                                    {/* ÏÉÅÌÉú Î©îÏãúÏßÄ */}
                                    <div className="d-flex justify-content-between align-items-center mb-3">
                                        <small className="text-muted">
                                            {totalAttempts >= streakInfo.requiredDaily ? 
                                                'Ïò§Îäò Î™©Ìëú Îã¨ÏÑ±! üéâ' : 
                                                `Ïò§Îäò ${streakInfo.requiredDaily - totalAttempts}Í∞ú Îçî ÌïÑÏöî`}
                                        </small>
                                        {streakInfo?.bonus?.next && (
                                            <small className="text-muted">
                                                Îã§Ïùå: {streakInfo.bonus.next.emoji} {streakInfo.bonus.next.title} 
                                                ({streakInfo.bonus.next.days - streakInfo.streak}Ïùº ÎÇ®Ïùå)
                                            </small>
                                        )}
                                    </div>

                                    {/* Ïò§Îäò ÌïôÏäµ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ - Ìï≠ÏÉÅ ÌëúÏãú */}
                                    <div className="border-top pt-3 position-relative">
                                        <div className="d-flex justify-content-between align-items-center mb-2">
                                            <small className="text-muted">
                                                {totalAttempts > 0 ? (
                                                    <>üìä Ïò§Îäò ÌïôÏäµ: {totalAttempts}Ìöå | Ïò§ÎãµÏú®: <span className={errorRate > 30 ? 'text-danger' : errorRate > 15 ? 'text-warning' : 'text-success'}>{errorRate}%</span>
                                                    {isEstimated && <span className="text-info"> (Ï∂îÏ†ï)</span>}</>
                                                ) : (
                                                    <>üìä Ïò§Îäò ÌïôÏäµ: 0Ìöå | Ïò§ÎãµÏú®: 0%</>
                                                )}
                                            </small>
                                            <button 
                                                ref={dropdownButtonRef}
                                                className="btn btn-sm btn-outline-secondary"
                                                onClick={() => setShowStudyDetails(!showStudyDetails)}
                                                style={{ fontSize: '0.75rem', padding: '0.25rem 0.5rem' }}
                                            >
                                                {showStudyDetails ? 'Ïà®Í∏∞Í∏∞' : 'ÏÉÅÏÑ∏Î≥¥Í∏∞'} {showStudyDetails ? '‚ñ≤' : '‚ñº'}
                                            </button>
                                        </div>
                                        
                                    </div>
                                </>
                            ) : (
                                <div className="text-center">
                                    <span className="text-muted">Ïó∞ÏÜçÌïôÏäµ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </section>

            {/* Îπ†Î•∏ ÏãúÏûë */}
            <section style={{ overflow: 'visible' }}>
                <h4 className="mb-3">Îπ†Î•∏ ÏãúÏûë</h4>
                <div className="row g-3" style={{ overflow: 'visible' }}>
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">SRS ÌïôÏäµ</h5>
                                <p className="card-text text-muted">Ïò§Îäò Î≥µÏäµÌï† Îã®Ïñ¥Îì§ÏùÑ Leitner ÏãúÏä§ÌÖúÏúºÎ°ú ÌïôÏäµÌï©ÎãàÎã§.</p>
                                <button 
                                    className="btn btn-primary"
                                    onClick={async () => {
                                        try {
                                            // Î™®Îì† overdue Ïπ¥ÎìúÏùò vocabId Ï°∞Ìöå
                                            const availableData = await fetchJSON(`/srs/available`, withCreds());
                                            
                                            if (Array.isArray(availableData?.data) && availableData.data.length > 0) {
                                                // overdue Ïπ¥ÎìúÎì§Ïùò vocabId Ï∂îÏ∂ú
                                                const vocabIds = availableData.data
                                                    .map(card => card.srsfolderitem?.[0]?.vocabId || card.srsfolderitem?.[0]?.vocab?.id)
                                                    .filter(Boolean);
                                                
                                                if (vocabIds.length > 0) {
                                                    // learn/vocab ÏãúÏä§ÌÖúÏúºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ (Ï†ÑÏ≤¥ overdue Î™®Îìú)
                                                    window.location.href = `/learn/vocab?mode=all_overdue&selectedItems=${vocabIds.join(',')}`;
                                                } else {
                                                    alert('Î≥µÏäµÌï† Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                                                }
                                            } else {
                                                alert('Î≥µÏäµÌï† Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                                            }
                                        } catch (error) {
                                            console.error('Failed to start SRS learning:', error);
                                            alert('ÌïôÏäµÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                                        }
                                    }}
                                >
                                    ÌïôÏäµ ÏãúÏûë
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">Ïò§Îãµ ÎÖ∏Ìä∏</h5>
                                <p className="card-text text-muted">Ïù¥Ï†ÑÏóê ÌãÄÎ†∏Îçò Îã®Ïñ¥Îì§ÏùÑ ÏßëÏ§ëÏ†ÅÏúºÎ°ú Îã§Ïãú ÌïôÏäµÌï©ÎãàÎã§.</p>
                                <Link to="/odat-note" className="btn btn-danger">Ïò§Îãµ ÌôïÏù∏</Link>
                            </div>
                        </div>
                    </div>
                    <div className="col-md-6">
                        <div className="card">
                            <div className="card-body">
                                <h5 className="card-title">ÎÇ¥ Îã®Ïñ¥Ïû•</h5>
                                <p className="card-text text-muted">ÏßÅÏ†ë Ï∂îÍ∞ÄÌïú Îã®Ïñ¥Îì§ÏùÑ Í¥ÄÎ¶¨ÌïòÍ≥†, Ìè¥ÎçîÎ≥ÑÎ°ú ÌïôÏäµÌï©ÎãàÎã§.</p>
                                <Link to="/my-wordbook" className="btn btn-outline-secondary">Îã®Ïñ¥Ïû• Í∞ÄÍ∏∞</Link>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            {/* ÎßàÏä§ÌÑ∞Îêú Îã®Ïñ¥ Î™®Îã¨ */}
            {showMasteredDetails && createPortal(
                <div 
                    style={{ 
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 999999,
                        padding: '20px'
                    }}
                    onClick={() => setShowMasteredDetails(false)}
                >
                    <div 
                        style={{ 
                            backgroundColor: '#ffffff',
                            border: '2px solid #ffc107',
                            borderRadius: '0.5rem',
                            boxShadow: '0 1rem 3rem rgba(255, 193, 7, 0.3)',
                            fontSize: '0.9rem',
                            maxHeight: '80vh',
                            overflowY: 'auto',
                            width: '100%',
                            maxWidth: '700px',
                            position: 'relative'
                        }}
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Î™®Îã¨ Ìó§Îçî */}
                        <div className="d-flex justify-content-between align-items-center p-3 border-bottom bg-warning bg-opacity-10">
                            <h5 className="mb-0 text-warning">üèÜ ÎßàÏä§ÌÑ∞Ìïú Îã®Ïñ¥Îì§</h5>
                            <button 
                                className="btn-close" 
                                onClick={() => setShowMasteredDetails(false)}
                                aria-label="Close"
                            ></button>
                        </div>
                        
                        {/* Î™®Îã¨ Î∞îÎîî */}
                        <div className="p-3">
                            {masteredCards.length > 0 ? (
                                <>
                                    <div className="mb-3 text-center">
                                        <small className="text-muted">
                                            Ï¥ù {masteredCards.length}Í∞úÏùò Îã®Ïñ¥Î•º ÎßàÏä§ÌÑ∞ÌñàÏäµÎãàÎã§! üéâ
                                        </small>
                                    </div>
                                    <div className="row g-2">
                                        {masteredCards
                                            .sort((a, b) => new Date(b.masteredAt) - new Date(a.masteredAt))
                                            .map((card, index) => {
                                                const vocab = card.srsfolderitem?.[0]?.vocab || {};
                                                const masterCycles = card.masterCycles || 1;
                                                
                                                return (
                                                    <div key={card.id || index} className="col-sm-6 col-md-4">
                                                        <div className="card h-100 border-warning bg-light position-relative">
                                                            {/* Î¨¥ÏßÄÍ∞ú Î≥Ñ */}
                                                            <RainbowStar 
                                                                size="small" 
                                                                cycles={masterCycles} 
                                                                className="position-absolute top-0 end-0 m-2"
                                                            />
                                                            
                                                            <div className="card-body p-2">
                                                                <h6 className="card-title mb-1" style={{ marginRight: '30px' }}>
                                                                    {vocab.lemma || 'Unknown'}
                                                                </h6>
                                                                {vocab.pos && (
                                                                    <small className="text-muted">{vocab.pos}</small>
                                                                )}
                                                                {vocab.ko_gloss && (
                                                                    <p className="card-text small mb-1">
                                                                        {vocab.ko_gloss.slice(0, 50)}
                                                                        {vocab.ko_gloss.length > 50 ? '...' : ''}
                                                                    </p>
                                                                )}
                                                                <div className="text-warning small">
                                                                    üèÜ {dayjs(card.masteredAt).format('MM/DD')} ÎßàÏä§ÌÑ∞
                                                                </div>
                                                                {masterCycles > 1 && (
                                                                    <div className="text-success small">
                                                                        ‚≠ê {masterCycles}Ìöå ÎßàÏä§ÌÑ∞
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        }
                                    </div>
                                </>
                            ) : (
                                <div className="text-center py-4">
                                    <span className="text-muted h5">üåü ÏïÑÏßÅ ÎßàÏä§ÌÑ∞Ìïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</span>
                                    <br />
                                    <small className="text-muted">Íæ∏Ï§ÄÌûà ÌïôÏäµÌï¥ÏÑú Ï≤´ ÎßàÏä§ÌÑ∞Î•º Îã¨ÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</small>
                                </div>
                            )}
                        </div>
                        
                        {/* Î™®Îã¨ Ìë∏ÌÑ∞ */}
                        <div className="p-3 border-top text-center bg-warning bg-opacity-10">
                            <button 
                                className="btn btn-warning btn-sm"
                                onClick={() => setShowMasteredDetails(false)}
                            >
                                Îã´Í∏∞
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}

            {/* Ïò§Îäò ÌïôÏäµ Îã®Ïñ¥ Î™®Îã¨ */}
            {showStudyDetails && createPortal(
                <div 
                    style={{ 
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 999999,
                        padding: '20px'
                    }}
                    onClick={() => setShowStudyDetails(false)}
                >
                    <div 
                        style={{ 
                            backgroundColor: '#ffffff',
                            border: '2px solid #dee2e6',
                            borderRadius: '0.5rem',
                            boxShadow: '0 1rem 3rem rgba(0, 0, 0, 0.175)',
                            fontSize: '0.9rem',
                            maxHeight: '80vh',
                            overflowY: 'auto',
                            width: '100%',
                            maxWidth: '500px',
                            position: 'relative'
                        }}
                        onClick={(e) => e.stopPropagation()}
                    >
                        {/* Î™®Îã¨ Ìó§Îçî */}
                        <div className="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <h5 className="mb-0 text-primary">üìä Ïò§Îäò ÌïôÏäµÌïú Îã®Ïñ¥Îì§</h5>
                            <button 
                                className="btn-close" 
                                onClick={() => setShowStudyDetails(false)}
                                aria-label="Close"
                            ></button>
                        </div>
                        
                        {/* Î™®Îã¨ Î∞îÎîî */}
                        <div className="p-3">
                            {Object.keys(wordFirstAttempts || {}).length > 0 ? (
                                <>
                                    <div className="mb-3">
                                        <small className="text-muted">
                                            Ï¥ù {Object.keys(wordFirstAttempts || {}).length}Í∞ú Îã®Ïñ¥ | 
                                            Ï†ïÎãµ: {Object.values(wordFirstAttempts || {}).filter(a => a.isCorrect).length}Í∞ú | 
                                            Ïò§Îãµ: {Object.values(wordFirstAttempts || {}).filter(a => !a.isCorrect).length}Í∞ú
                                        </small>
                                    </div>
                                    <div className="d-flex flex-wrap gap-2">
                                        {/* lemmaÎ≥Ñ Ï≤´ ÌïôÏäµÎßå ÌëúÏãú */}
                                        {Object.values(wordFirstAttempts)
                                            .sort((a, b) => new Date(b.time) - new Date(a.time))
                                            .map((attempt, index) => {
                                                // Ï≤´ ÌïôÏäµ Í≤∞Í≥ºÏóê Îî∞Î•∏ Ïä§ÌÉÄÏùº
                                                const badgeClass = attempt.isCorrect ? 'bg-success' : 'bg-danger';
                                                const icon = attempt.isCorrect ? '‚úÖ' : '‚ùå';
                                                
                                                return (
                                                    <span key={`${attempt.word}_${index}`} className={`badge ${badgeClass} mb-2 me-1`} style={{fontSize: '0.8rem', display: 'inline-block', whiteSpace: 'nowrap', padding: '0.5rem 0.75rem'}}>
                                                        {icon} {attempt.word} <small className="opacity-75">[F{attempt.folderId}]</small>
                                                    </span>
                                                );
                                            })
                                        }
                                    </div>
                                </>
                            ) : totalAttempts > 0 && isEstimated ? (
                                <div className="text-center py-4">
                                    <span className="text-info h5">üìö {totalAttempts}Ìöå ÌïôÏäµ ÏôÑÎ£å!</span>
                                    <br />
                                    <small className="text-muted">ÏÉÅÏÑ∏ ÌïôÏäµ Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</small>
                                </div>
                            ) : (
                                <div className="text-center py-4">
                                    <span className="text-muted h5">ü¶ú ÏïÑÏßÅ ÌïôÏäµÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§.</span>
                                    <br />
                                    <small className="text-muted">SRS ÌïôÏäµÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</small>
                                </div>
                            )}
                        </div>
                        
                        {/* Î™®Îã¨ Ìë∏ÌÑ∞ */}
                        <div className="p-3 border-top text-center">
                            <button 
                                className="btn btn-secondary btn-sm"
                                onClick={() => setShowStudyDetails(false)}
                            >
                                Îã´Í∏∞
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            )}

            {/* Ïñ∏Ïñ¥ ÏÑ†ÌÉù Î™®Îã¨ */}
            <LanguageSelectionModal
                show={showLanguageModal}
                onHide={() => setShowLanguageModal(false)}
                japaneseCount={stats.srsJapanese || 0}
                englishCount={stats.srsEnglish || 0}
                onSelectLanguage={handleLanguageSelect}
            />
        </main>
    );
}
