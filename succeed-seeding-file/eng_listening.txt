# 영어 리스닝 즉각 반영 문제 해결 진행 상황
생성일: 2025-09-23

## 🚨 문제 발생 및 해결 과정

### 1. ❌ 문제 발생 (2025-09-23)
- **문제**: 영어 리스닝 문제를 풀고 난 후 목록 페이지에서 정답/오답 횟수가 즉각 반영되지 않음
- **증상**:
  - 오답노트에는 즉각 반영됨
  - 목록 페이지에서는 페이지 새로고침 전까지 반영 안됨
  - 일본어 리스닝과 달리 영어 리스닝만 문제 발생

### 2. 🔧 시도한 해결책들

#### A. 프론트엔드 실시간 업데이트 강화
✅ **적용된 수정사항**:
- 문제 풀이 후 localStorage/sessionStorage에 다중 이벤트 저장
- `wrongAnswersUpdated`, `listeningRecordUpdated`, `forceListeningRefresh` 이벤트 추가
- 페이지 포커스/창 포커스 시 자동 새로고침
- URL 파라미터를 통한 강제 새로고침

#### B. 백엔드 로직 수정 시도 (❌ 실패 - 롤백됨)
❌ **시도했으나 롤백된 수정사항**:
- 정답인 경우에도 `wronganswer` 테이블에 기록 저장하도록 변경
- **문제**: 기존 모든 정답/오답 기록이 사라짐
- **해결**: 백엔드 로직을 원래대로 복구

#### C. 페이지 이동 방식 변경
✅ **적용된 수정사항**:
- `navigate()` 대신 `window.location.replace()` 사용
- 완전한 페이지 새로고침으로 캐시 무시

#### D. API 요청 최적화 (❌ 문제 발생 - 롤백됨)
❌ **시도했으나 롤백된 수정사항**:
- API 요청 시 `cache: 'no-cache'` 헤더 추가
- 타임스탬프를 URL 파라미터로 추가
- **문제**: 기존 데이터 표시에 문제 발생
- **해결**: 원래 API 요청 방식으로 복구

### 3. 🔍 근본 원인 분석

#### 현재 시스템 구조:
```
정답 → listeningRecord 테이블에만 저장
오답 → wronganswer 테이블에 저장 (오답노트)
```

#### 문제의 핵심:
- **오답노트**: `wronganswer` 테이블만 조회하므로 즉각 반영
- **목록 페이지**: `wronganswer` + `listeningRecord` 테이블을 합쳐서 조회
- **정답 기록**: `listeningRecord` 테이블에만 저장되어 실시간 반영 어려움

### 4. ✅ 현재 적용된 해결책

#### 프론트엔드 실시간 업데이트:
```javascript
// ListeningPractice.jsx - 문제 풀이 후
localStorage.setItem('wrongAnswersUpdated', timestamp);
localStorage.setItem('listeningRecordUpdated', timestamp);
localStorage.setItem('forceListeningRefresh', timestamp);
sessionStorage.setItem('needsRefresh', 'true');

// 이벤트 발생
window.dispatchEvent(new CustomEvent('wrongAnswersUpdated'));
window.dispatchEvent(new CustomEvent('listeningRecordUpdated'));
window.dispatchEvent(new CustomEvent('forceListeningRefresh'));
```

#### 페이지 이동 방식:
```javascript
// 뒤로가기 버튼
window.location.replace(`/listening/list?level=${level}&t=${Date.now()}`);
```

#### 이벤트 감지:
```javascript
// ListeningList.jsx
window.addEventListener('wrongAnswersUpdated', handleWrongAnswersUpdate);
window.addEventListener('listeningRecordUpdated', handleWrongAnswersUpdate);
window.addEventListener('forceListeningRefresh', handleWrongAnswersUpdate);
document.addEventListener('visibilitychange', handleVisibilityChange);
window.addEventListener('focus', handleFocus);
```

### 5. 🔄 현재 상태

#### ✅ 복구 완료:
- 기존 정답/오답 기록 모두 정상 표시
- 백엔드 로직 원래대로 복구
- 프론트엔드 데이터 로딩 로직 복구

#### ⚠️ 여전히 남은 문제:
- 영어 리스닝 목록에서 즉각 반영이 완전하지 않음
- 페이지 새로고침 또는 포커스 변경 시에만 반영됨

### 6. 🎯 향후 개선 방향

#### A. 안전한 실시간 업데이트 방식:
1. **폴링 방식**: 일정 시간마다 백엔드에서 최신 데이터 조회
2. **WebSocket**: 실시간 양방향 통신으로 즉시 업데이트
3. **상태 관리**: Redux/Zustand 등으로 전역 상태 동기화

#### B. 데이터베이스 구조 개선:
1. 통합 테이블 생성으로 단일 소스 진실 구현
2. 캐싱 레이어 추가로 성능 최적화
3. 이벤트 기반 아키텍처 도입

### 7. 📊 테스트 결과

#### ✅ 정상 작동:
- 기존 데이터 보존 및 표시
- 백엔드 API 정상 동작
- 오답노트 즉각 반영

#### ⚠️ 부분적 작동:
- 페이지 포커스 시 업데이트
- 뒤로가기 시 강제 새로고침

#### ❌ 미해결:
- 문제 풀이 후 즉각적인 목록 업데이트
- 완전 자동화된 실시간 반영

## 🎯 결론

현재 기존 데이터는 모두 복구되었으며, 부분적인 실시간 업데이트는 작동하고 있습니다.
완전한 즉각 반영을 위해서는 더 안전하고 체계적인 접근이 필요합니다.

**권장사항**: 현재 상태를 유지하면서 WebSocket이나 폴링 방식을 통한 점진적 개선을 진행하는 것이 안전합니다.